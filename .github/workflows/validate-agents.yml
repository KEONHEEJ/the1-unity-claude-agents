name: Validate Unity Agents

on:
  push:
    branches: [ main, master, develop ]
    paths:
      - 'agents/**/*.md'
      - '.github/workflows/validate-agents.yml'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'agents/**/*.md'

jobs:
  validate-agents:
    runs-on: [self-hosted, linux, x64, arc, the1studio, org]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyyaml

    - name: Validate agent YAML frontmatter
      run: |
        python -c "
        import os
        import yaml
        import sys

        def validate_agent_file(file_path):
            with open(file_path, 'r', encoding='utf-8') as f:
                content = f.read()

            if not content.startswith('---'):
                print(f'‚ùå {file_path}: Missing YAML frontmatter')
                return False

            try:
                parts = content.split('---', 2)
                if len(parts) < 3:
                    print(f'‚ùå {file_path}: Invalid frontmatter format')
                    return False

                frontmatter = yaml.safe_load(parts[1])

                # Required fields for Claude Code agent format
                required_fields = ['name', 'description']
                for field in required_fields:
                    if field not in frontmatter:
                        print(f'‚ùå {file_path}: Missing required field: {field}')
                        return False

                # Validate name is a non-empty string
                if not isinstance(frontmatter['name'], str) or not frontmatter['name'].strip():
                    print(f'‚ùå {file_path}: name must be a non-empty string')
                    return False

                # Validate description is a non-empty string
                if not isinstance(frontmatter['description'], str) or not frontmatter['description'].strip():
                    print(f'‚ùå {file_path}: description must be a non-empty string')
                    return False

                # Validate tools field if present
                if 'tools' in frontmatter:
                    if not isinstance(frontmatter['tools'], str) or not frontmatter['tools'].strip():
                        print(f'‚ùå {file_path}: tools must be a non-empty string')
                        return False

                print(f'‚úÖ {file_path}')
                return True

            except yaml.YAMLError as e:
                print(f'‚ùå {file_path}: YAML parsing error: {e}')
                return False

        agent_files = []
        for root, dirs, files in os.walk('agents'):
            for file in files:
                if file.endswith('.md'):
                    agent_files.append(os.path.join(root, file))

        if not agent_files:
            print('No agent files found')
            sys.exit(0)

        valid_count = 0
        for file_path in sorted(agent_files):
            if validate_agent_file(file_path):
                valid_count += 1

        print(f'\nüìä Validation Summary: {valid_count}/{len(agent_files)} agents valid')

        if valid_count != len(agent_files):
            sys.exit(1)
        "

    - name: Check for duplicate agent names
      run: |
        python -c "
        import os
        import yaml
        from collections import defaultdict

        names = defaultdict(list)

        for root, dirs, files in os.walk('agents'):
            for file in files:
                if file.endswith('.md'):
                    file_path = os.path.join(root, file)
                    with open(file_path, 'r', encoding='utf-8') as f:
                        content = f.read()

                    if content.startswith('---'):
                        try:
                            parts = content.split('---', 2)
                            frontmatter = yaml.safe_load(parts[1])
                            if 'name' in frontmatter:
                                names[frontmatter['name']].append(file_path)
                        except:
                            continue

        duplicates = {name: files for name, files in names.items() if len(files) > 1}

        if duplicates:
            print('‚ùå Duplicate agent names found:')
            for name, files in duplicates.items():
                print(f'  Name \"{name}\" in: {files}')
            exit(1)
        else:
            print('‚úÖ No duplicate agent names found')
        "

    - name: Validate routing consistency
      run: |
        python -c "
        import os
        import yaml

        # Agents that should exist according to CLAUDE.md routing table
        expected_agents = {
            'unity-omc-bridge',
            'unity-researcher',
            'unity-verifier',
            'unity-gameplay-programmer',
            'unity-code-reviewer',
            'unity-performance-optimizer',
            'unity-ui-developer',
            'unity-shader-programmer',
            'unity-tech-lead-orchestrator',
            'unity-team-lead',
            'unity-team-configurator',
            'unity-project-analyst',
            'code-reviewer',
            'performance-optimizer',
            'documentation-specialist',
        }

        found_agents = set()
        for root, dirs, files in os.walk('agents'):
            for file in files:
                if file.endswith('.md'):
                    file_path = os.path.join(root, file)
                    with open(file_path, 'r', encoding='utf-8') as f:
                        content = f.read()
                    if content.startswith('---'):
                        try:
                            parts = content.split('---', 2)
                            frontmatter = yaml.safe_load(parts[1])
                            if 'name' in frontmatter:
                                found_agents.add(frontmatter['name'])
                        except:
                            continue

        missing = expected_agents - found_agents
        if missing:
            print(f'‚ö†Ô∏è  Missing expected agents: {missing}')
            print('These agents are referenced in routing tables but not found.')
        else:
            print('‚úÖ All expected routing agents found')

        print(f'\nüìä Total agents: {len(found_agents)}')
        print(f'Expected agents verified: {len(expected_agents - missing)}/{len(expected_agents)}')
        "

    - name: Generate validation report
      if: always()
      run: |
        echo "## Agent Validation Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        AGENT_COUNT=$(find agents -name "*.md" 2>/dev/null | wc -l)
        echo "üìä **Total Agents:** $AGENT_COUNT" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        echo "### Agent Directory Structure" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        find agents -type d | sort >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        echo "### Agents by Category" >> $GITHUB_STEP_SUMMARY
        find agents -name "*.md" | sort | while read file; do
          category=$(dirname "$file" | sed 's|.*agents/||')
          agent=$(basename "$file" .md)
          echo "- **$category**: $agent" >> $GITHUB_STEP_SUMMARY
        done

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### New OMC Integration Agents" >> $GITHUB_STEP_SUMMARY
        for agent in "unity-omc-bridge" "unity-researcher" "unity-verifier"; do
          if find agents -name "${agent}.md" | grep -q .; then
            echo "- ‚úÖ $agent" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ‚ùå $agent (missing)" >> $GITHUB_STEP_SUMMARY
          fi
        done
